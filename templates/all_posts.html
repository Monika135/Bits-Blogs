{% extends "base.html" %}

{% block title %}All Posts - Bits & Blogs{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">

            <!-- Header + Create button -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-newspaper"></i> All Posts</h2>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('post.create_post_page') }}" class="btn btn-primary" id="createPostBtn" style="display: none;">
                        <i class="fas fa-plus"></i> Create New Post
                    </a>
                </div>
            </div>

            <!-- Search + Pagination Controls -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <input type="text" id="searchInput" class="form-control w-50" placeholder="Search posts...">
                <div class="pagination-controls">
                    <button id="prevPage" class="btn btn-outline-primary btn-sm">Previous</button>
                    <span id="pageInfo"></span>
                    <button id="nextPage" class="btn btn-outline-primary btn-sm">Next</button>
                </div>
            </div>

            <!-- Posts container -->
            <div id="postsContainer" class="posts-grid">
                <!-- Posts loaded here via JS -->
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this post? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete Post</button>
            </div>
        </div>
    </div>
</div>

<!-- Styles -->
<style>
.posts-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: flex-start;
}
.post-card {
    flex: 1 1 300px;
    max-width: 500px;
    min-height: 250px;
    display: flex;
    flex-direction: column;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
}
.post-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}
.post-image { width: 100%; height: 200px; object-fit: cover; border-bottom: 1px solid #eee; }
.post-content { padding: 20px; flex: 1; display: flex; flex-direction: column; }
.post-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 10px; color: #333; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.post-text { color: #666; line-height: 1.5; margin-bottom: 15px; flex: 1; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
.post-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 0.9rem; color: #888; }
.post-actions { margin-top: auto; }
.action-buttons { display: flex; gap: 7px; flex-wrap: wrap; }
.btn-action { padding: 6px 11px; border: none; border-radius: 6px; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 4px; text-decoration: none; transition: all 0.2s; }
.btn-read { background: #007bff; color: white; } .btn-read:hover { background: #0056b3; color: white; }
.btn-like { background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; } 
.btn-like.liked { background: #dc3545; color: white; border-color: #dc3545; }
.btn-like:hover { background: #e9ecef; color: #495057; } 
.btn-like.liked:hover { background: #c82333; color: white; }
.btn-comment { background: #28a745; color: white; } .btn-comment:hover { background: #1e7e34; color: white; }
.btn-edit { background: #ffc107; color: #212529; } .btn-edit:hover { background: #e0a800; color: #212529; }
.btn-delete { background: #dc3545; color: white; } .btn-delete:hover { background: #c82333; color: white; }
.like-info { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; color: #666; }
.like-count { font-weight: 500; }
.admin-actions { background: linear-gradient(45deg,#ff6b6b,#ffa500); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; }
/* Responsive */
@media (max-width:768px){.posts-grid{flex-direction:column;gap:15px;}.post-card{flex:none;max-width:none;}.action-buttons{flex-wrap:wrap;}.btn-action{font-size:0.8rem;padding:5px 10px;}}
@media (min-width:769px) and (max-width:1024px){.post-card{flex:1 1 45%;}}
@media (min-width:1025px){.post-card{flex:1 1 30%;}}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
<script>
const socket = io();
let currentPostId = null;
let currentPage = 1;
let perPage = 5;
let totalPages = 1;

document.addEventListener('DOMContentLoaded', function() {
    const token = getToken();
    if (!token) { window.location.href = "{{ url_for('auth.login_page') }}"; return; }

    updateNavigation();
    document.getElementById('createPostBtn').style.display = 'block';
    loadPosts();
    // Join rooms for visible posts after load
    setTimeout(joinVisiblePostRooms, 600);

    // Search
    document.getElementById('searchInput').addEventListener('input', function() {
        currentPage = 1;
        loadPosts();
    });

    // Pagination buttons
    document.getElementById('prevPage').addEventListener('click', function() {
        if(currentPage>1){currentPage--;loadPosts();}
    });
    document.getElementById('nextPage').addEventListener('click', function() {
        if(currentPage<totalPages){currentPage++;loadPosts();}
    });

    // Delete confirmation
    document.getElementById('confirmDelete').addEventListener('click', function() {
        if(currentPostId) deletePost(currentPostId);
    });
});

function loadPosts() {
    const token = getToken();
    const searchQuery = document.getElementById('searchInput').value;

    fetch(`/post/view_post/?page=${currentPage}&per_page=${perPage}&search=${encodeURIComponent(searchQuery)}`, {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token }
    })
    .then(res => res.json())
    .then(data => {
        if (!data.posts) {
            document.getElementById('postsContainer').innerHTML = '<div class="alert alert-info">No posts found.</div>';
            return;
        }
        totalPages = data.meta.total_pages || 1;
        document.getElementById('pageInfo').textContent = `Page ${data.meta.page} of ${totalPages}`;
        displayPosts(data.posts);
        document.getElementById('prevPage').disabled = !data.meta.has_prev;
        document.getElementById('nextPage').disabled = !data.meta.has_next;
    })
    .catch(err => {
        console.error('Error loading posts:', err);
        document.getElementById('postsContainer').innerHTML = '<div class="alert alert-danger">Error loading posts.</div>';
    });
}

function displayPosts(posts) {
    const container = document.getElementById('postsContainer');
    if(posts.length===0){container.innerHTML='<div class="alert alert-info">No posts available.</div>'; return;}
    let html='';
    posts.forEach(post=>{
        const createdDate = post.created_at ? new Date(post.created_at).toLocaleDateString() : 'Unknown';
        const currentUserId = getCurrentUserId();
        const userInfo = getCurrentUserInfo();
        const canEdit = post.can_edit||false;
        const canDelete = post.can_delete||false;

        html+=`
        <div class="post-card">
            ${post.image_url?`<img src="${post.image_url}" class="post-image" alt="${post.title}">`:''}
            <div class="post-content">
                <h5 class="post-title">${post.title}</h5>
                <p class="post-text">${post.content}</p>
                <div class="post-meta">
                    <span><i class="fas fa-user"></i> ${post.author_username}</span>
                    <span><i class="fas fa-calendar"></i> ${createdDate}</span>
                </div>
                <div class="post-actions">
                    <div class="action-buttons">
                        <a href="/post/detail/${post.post_id}/" class="btn-action btn-read">
                            <i class="fas fa-eye"></i> Read
                        </a>
                        <button class="btn-action btn-like ${post.is_liked?'liked':''}" onclick="toggleLike('${post.post_id}', this)">
                            <i class="fas fa-heart"></i> <span class="like-count">${post.like_count||0}</span>
                        </button>
                        <a href="/post/detail/${post.post_id}/#comments" class="btn-action btn-comment">
                            <i class="fas fa-comment"></i> Comment
                        </a>
                        ${canEdit?`<a href="/post/edit/${post.post_id}/" class="btn-action btn-edit">Edit</a>`:''}
                        ${canDelete?`<button class="btn-action btn-delete" onclick="showDeleteModal('${post.post_id}')">Delete</button>`:''}
                    </div>
                </div>
            </div>
        </div>`;
    });
    container.innerHTML = html;
    // After rendering, join each post room for live updates
    joinVisiblePostRooms();
}
function joinVisiblePostRooms(){
    if(!window.socket) return;
    document.querySelectorAll('#postsContainer .post-card').forEach(card=>{
        const link = card.querySelector('a.btn-read');
        const href = link ? link.getAttribute('href') : '';
        const parts = href.split('/').filter(Boolean);
        const postId = parts[parts.length-1];
        if(postId){ window.socket.emit('join_post', { post_id: postId }); }
    });
}

function toggleLike(postId, buttonElement) {
    const token = getToken();
    if(!token){ window.location.href="{{ url_for('auth.login') }}"; return; }

    fetch(`/post/like_post/${postId}/`, {
        method:'POST',
        headers:{ 'Authorization':'Bearer '+token,'Content-Type':'application/json' }
    }).then(res=>res.json()).then(data=>{
        if(data.status==='success'){
            const likeCountSpan = buttonElement.querySelector('.like-count');
            likeCountSpan.textContent = data.like_count;
            if(data.liked){ buttonElement.classList.add('liked'); }
            else{ buttonElement.classList.remove('liked'); }
        }
    }).catch(err=>console.error(err));
}

function showDeleteModal(postId){
    currentPostId = postId;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function deletePost(postId){
    const token = getToken();
    if(!token){ window.location.href="{{ url_for('auth.login') }}"; return; }

    fetch(`/post/delete_post/${postId}/`, {
        method:'POST',
        headers:{ 'Authorization':'Bearer '+token,'Content-Type':'application/json' }
    }).then(res=>res.json()).then(data=>{
        if(data.status==='success'){
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();
            loadPosts();
        }
    }).catch(err=>console.error(err));
}

function getCurrentUserId(){
    const token = getToken();
    if(token){
        try{
            const payload = JSON.parse(atob(token.split('.')[1]));
            return payload.sub;
        }catch(e){return null;}
    }
    return null;
}

document.querySelectorAll('.post-card').forEach(post => {
    const postId = post.dataset.postId;
    socket.emit('join_post', { post_id: postId });
});

// Real-time comment submission
function submitComment(postId) {
    const input = document.getElementById(`commentInput_${postId}`);
    const content = input.value;
    const token = getToken();
    if (!content || !token) return;

    socket.emit('new_comment', {
        post_id: postId,
        content: content,
        token: token
    });

    input.value = '';
}

// Listen for new comments
socket.on('comment_broadcast', data => {
    const container = document.getElementById(`commentsContainer_${data.post_id}`);
    if (container) {
        const html = `<p><strong>User ${data.author_id}:</strong> ${data.content}</p>`;
        container.insertAdjacentHTML('beforeend', html);
    }
});
// Listen for like updates
socket.on('like_update', data => {
    const cardList = document.querySelectorAll('#postsContainer .post-card');
    cardList.forEach(card => {
        const readLink = card.querySelector('a.btn-read');
        const href = readLink ? readLink.getAttribute('href') : '';
        if(href.includes(`/${data.post_id}/`)){
            const btn = card.querySelector('.btn-like .like-count');
            if(btn){ btn.textContent = data.like_count; }
        }
    });
});

// Listen for notifications
socket.on('notification', data => {
    showAlert(data.msg, 'info');
});

// Handle likes
function likePost(postId, buttonElement) {
    const token = getToken();
    if (!token) return;

    fetch(`/post/like_post/${postId}/`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token }
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            const likeCount = buttonElement.querySelector('.like-count');
            likeCount.textContent = data.like_count;
            if (data.liked) buttonElement.classList.add('liked');
            else buttonElement.classList.remove('liked');

            // Notify via SocketIO
            socket.emit('like_post', { post_id: postId, token: token });
        }
    });
}
</script>
{% endblock %}
